name: Publish Package

on:
  push:
    branches:
      - 'master'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_ACCESS_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "uilibrary"
          git config --global user.email "ab.uitools@gmail.com"

      - name: Specify Node Version
        uses: actions/setup-node@v3
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: yarn

      - name: Create .npmrc file
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_AUTH_TOKEN }}" > ~/.npmrc

#      - name: Check Lerna version
#        env:
#          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
#          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
#        run: yarn lerna changed

      - name: Version packages using Lerna
        run: |
          yarn lerna version --conventional-commits --yes
        env:
          NPM_CONFIG_REGISTRY: "https://registry.npmjs.org"
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      - name: Build packages with Lerna
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
        run: yarn lerna-build

#          yarn lerna publish from-package --yes

      - name: Publish private packages
        run: |
          yarn lerna publish from-package --ignore-changes packages/storybook --yes
        env:
          NPM_CONFIG_REGISTRY: "https://registry.npmjs.org"
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      - name: Extract Lerna package versions
        id: lerna-versions
        run: |
          CHANGED=$(git diff HEAD~1 HEAD --name-only -- 'packages/*/package.json' | grep -v storybook || true)
          if [ -z "$CHANGED" ]; then
            echo "packages_info=No package versions updated" >> $GITHUB_OUTPUT
          else
            ENTRIES=()
            for f in $CHANGED; do
              NAME=$(node -e "console.log(require('./$f').name)")
              VERSION=$(node -e "console.log(require('./$f').version)")
              ENTRIES+=("â€¢ ${NAME}@${VERSION}")
            done
            echo "packages_info=${ENTRIES[*]}" >> $GITHUB_OUTPUT
          fi

      - name: Post to Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.17.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#70aeff",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*New packages published to npm*"
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "${{ steps.lerna-versions.outputs.packages_info }}"
                      }
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "Repository: ${{ github.repository }} | Branch: ${{ github.ref_name }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.WEB_SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages/storybook/storybook-static
          enable_jekyll: false